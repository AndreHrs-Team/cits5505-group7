{# frontend/templates/education/schedule.html #}
{% extends "base.html" %}

{% block content%}
<div class="container mt-4">
  <p>Got your .ics subscription from CAS? Import it now:</p>
  <form action="{{ url_for('education.import_ics') }}" method="POST" enctype="multipart/form-data" class="mb-4">
    <input type="file" name="ics_file" hidden id="icsFileInput" onchange="this.form.submit()" />
    <button type="button" class="btn btn-primary" onclick="document.getElementById('icsFileInput').click()">
      Import cas .ics
    </button>
  </form>

  <div class="row">
    <!-- This Week’s Schedule -->
    <div class="col-md-6">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">This Week’s Schedule</h5>
          <a href="{{ url_for('education.calendar') }}" class="btn btn-outline-primary">
            <i class="fa-regular fa-calendar"></i> View Calendar
          </a>
        </div>

        {% if schedule %}
        {% for day, evs in schedule.items() %}
        <p class="fw-bold">{{ day }}</p>
        <ul class="mb-3">
          {% for e in evs %}
          <li>{{ e }}</li>
          {% endfor %}
        </ul>
        {% endfor %}
        {% else %}
        <p>No classes scheduled this week.</p>
        {% endif %}
      </div>
    </div>

    <!-- Upcoming Events & Add-Event button -->
    <div class="col-md-6">
      <div class="card p-3">
        <h5>Upcoming Events</h5>
        {% if upcoming_events %}
        {% for e in upcoming_events %}
        <div class="mb-3">
          <strong>{{ e.title }}</strong><br>
          {{ e.start }} <!-- 你没有 description 或 notes 字段传进来 -->
        </div>
        <div class="mb-3">
          {{ form.description.label }} {{ form.description(class="form-control") }}
        </div>

        {% endfor %}
        {% else %}
        <p>No upcoming events.</p>
        {% endif %}


        {# Trigger button OUTSIDE any <form> #}
          <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addEventModal">
            Add new event
          </button>
      </div>
    </div>
  </div>
</div>

{# Add Event Modal #}
<div class="modal fade" id="addEventModal" tabindex="-1" aria-labelledby="addEventModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('education.add_event') }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addEventModalLabel">Add new event</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {{ form.hidden_tag() }}
          <div class="mb-3">
            {{ form.title.label }} {{ form.title(class="form-control") }}
          </div>
          <div class="mb-3">
            {{ form.date.label }} {{ form.date(class="form-control") }}
          </div>
          <div class="mb-3">
            {{ form.time.label }} {{ form.time(class="form-control") }}
          </div>
          <div class="mb-3">
            {{ form.notes.label }} {{ form.notes(class="form-control", rows=3) }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            Save
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Ask for notification permission if available
    if ('Notification' in window) {
      Notification.requestPermission();
    }

    // upcoming_events passed from Flask view
    const events = {{ upcoming_events| tojson
  }};


  events.forEach(ev => {
    const evDate = new Date(ev.start);
    // calculate trigger time: one hour before class
    const triggerTime = evDate.getTime() - 60 * 60 * 1000;
    const now = Date.now();
    const delay = triggerTime - now;
    if (delay > 0) {
      setTimeout(() => {
        const message = `Upcoming class: ${ev.title} at ${evDate.toLocaleTimeString()}`;
        if (Notification.permission === 'granted') {
          new Notification('Class Reminder', { body: message });
        } else {
          alert(message);
        }
      }, delay);
    }
  });
    });
</script>
{% endblock %}